# EXAMPLE: Slack Chatbot with Knowledge Management - Commit Rules
# This is an EXAMPLE of project-specific commit rules
# DO NOT edit this file directly - it's in a git submodule
# Copy this structure to `.claude/config/conventional-commits.yaml` in your project

format:
  pattern: "{type}({scope}): {subject}"
  max_subject_length: 72
  max_body_line_length: 100

types:
  feat:
    description: "A new feature"
  fix:
    description: "A bug fix"
  refactor:
    description: "Code change that neither fixes a bug nor adds a feature"
  perf:
    description: "Performance improvement"
  test:
    description: "Adding or updating tests"
  docs:
    description: "Documentation changes"
  style:
    description: "Code style changes (formatting, whitespace)"
  build:
    description: "Build system or dependency changes"
  ci:
    description: "CI/CD configuration changes"
  chore:
    description: "Other changes that don't modify src or test files"

scopes:
  backend:
    description: "Changes to packages/backend (NestJS app with Slack + Bedrock + Knowledge Management)"
    patterns:
      - "packages/backend/**"
    subdomains:
      - "slack": "Slack integration (Bolt.js, events, threads)"
      - "bedrock": "Amazon Bedrock AI integration (Claude)"
      - "knowledge": "Knowledge base management (Git, Markdown)"
      - "rag": "RAG pipeline (OpenSearch, Redis)"
      - "memory": "Temporal memory (Redis) and confidence scoring"
      - "consolidation": "Nightly consolidation job"
      - "voting": "Emoji voting system"

  infra:
    description: "Changes to packages/infra (AWS CDK infrastructure)"
    patterns:
      - "packages/infra/**"
    subdomains:
      - "vpc": "VPC, subnets, networking"
      - "ecs": "ECS Fargate, ECR, container orchestration"
      - "opensearch": "OpenSearch Serverless vector store"
      - "redis": "ElastiCache Redis (temporal memory)"
      - "rds": "RDS PostgreSQL (update queue)"
      - "secrets": "Secrets Manager, SSM Parameter Store"
      - "iam": "IAM roles, policies"
      - "cloudwatch": "Logging, monitoring"

  monorepo:
    description: "Changes affecting multiple packages or workspace root"
    patterns:
      - "package.json"
      - "packages/*/package.json"
      - "tsconfig.base.json"

  tools:
    description: "Developer tooling (linters, scripts, CI/CD, Docker)"
    patterns:
      - "scripts/**"
      - "eslint.config.js"
      - ".prettierrc*"
      - ".github/workflows/**"
      - "Dockerfile"
      - "docker-compose*.yml"

  docs:
    description: "Documentation files (README, guides, roadmaps)"
    patterns:
      - "README*.md"
      - "SETUP.md"
      - "ROADMAP.md"
      - "DEPLOYMENT.md"
      - "*.md"

  project:
    description: "Project-level changes (CLAUDE.md, .claude/, git config)"
    patterns:
      - "CLAUDE.md"
      - ".claude/**"
      - ".gitignore"
      - ".editorconfig"

scope_selection_guide:
  description: "How to choose the correct scope based on file patterns"
  important: "Scope is determined by WHICH FILES are changed, not the type of change"

  mapping:
    slack_integration:
      pattern: "packages/backend/src/**/*slack*"
      scope: "backend"
      examples:
        - "feat(backend): Add thread tracking for conversations"
        - "fix(backend): Handle Slack retry events correctly"
      rationale: "Slack code is part of backend package"

    bedrock_ai:
      pattern: "packages/backend/src/**/*bedrock*"
      scope: "backend"
      examples:
        - "feat(backend): Integrate Claude Sonnet 4.5 via Bedrock"
        - "perf(backend): Optimize Bedrock prompt for RAG responses"
      rationale: "Bedrock integration is backend functionality"

    knowledge_base:
      pattern: "packages/backend/src/**/*knowledge*"
      scope: "backend"
      examples:
        - "feat(backend): Add Git-based Markdown knowledge storage"
        - "refactor(backend): Extract knowledge file parser"
      rationale: "Knowledge management is backend feature"

    infrastructure:
      pattern: "packages/infra/lib/**"
      scope: "infra"
      examples:
        - "feat(infra): Add OpenSearch Serverless for vector store"
        - "fix(infra): Correct ECS task IAM permissions"
        - "refactor(infra): Migrate Slack credentials to SSM Parameter Store"
      rationale: "CDK infrastructure code"

    docker:
      pattern: "Dockerfile, docker-compose*.yml"
      scope: "tools"
      examples:
        - "build(tools): Update Dockerfile to Node 25"
        - "fix(tools): Add health check to docker-compose"
      rationale: "Docker is developer tooling"

    ci_cd:
      pattern: ".github/workflows/**"
      scope: "tools"
      examples:
        - "ci(tools): Add ECS deployment workflow"
        - "fix(tools): Correct Docker build caching"
      rationale: "GitHub Actions is developer tooling"

    monorepo_config:
      pattern: "package.json (root), tsconfig.base.json"
      scope: "monorepo"
      examples:
        - "build(monorepo): Add npm workspace for shared types"
        - "chore(monorepo): Update TypeScript to 5.7"
      rationale: "Root config affects entire workspace"

    documentation:
      pattern: "README*.md, SETUP.md, ROADMAP.md"
      scope: "docs"
      examples:
        - "docs(project): Add deployment guide"
        - "docs(project): Update roadmap with Phase 1 progress"
      rationale: "Use 'docs' type with 'project' scope for project documentation, or package scope if doc is package-specific"

    project_meta:
      pattern: "CLAUDE.md, .claude/**, .gitignore"
      scope: "project"
      examples:
        - "chore(project): Update CLAUDE.md with Week 3 progress"
        - "feat(project): Add conventional-commits skill"
      rationale: "Project metadata and Claude Code configuration"

  common_mistakes:
    - mistake: "Using subdomain as scope (e.g., feat(slack):)"
      correct: "Use package scope: feat(backend): Add Slack thread tracking"
      explanation: "Subdomains (slack, bedrock, rag) help categorize changes but are not scopes"

    - mistake: "Using 'ai' or 'bedrock' as scope"
      correct: "Use 'backend' scope: feat(backend): Integrate Bedrock Claude model"
      explanation: "AI features are part of backend package"

    - mistake: "Using 'docker' as scope"
      correct: "Use 'tools' scope: build(tools): Update Dockerfile"
      explanation: "Docker is developer tooling"

    - mistake: "Using 'docs' as scope instead of type"
      correct: "docs(project): Update README"
      explanation: "'docs' is a TYPE (what you did), 'project' is the SCOPE (where)"

conventions:
  subject:
    - "Use imperative mood: 'Add feature' not 'Added feature'"
    - "Capitalize first letter when plain English (e.g., 'Add feature')"
    - "Don't capitalize if it starts with backticks, code, or special characters"
    - "No period at the end"
    - "Be specific but concise"

  body:
    - "Separate from subject with blank line"
    - "Explain what and why, not how"
    - "Wrap at 100 characters"
    - "Include relevant context (AWS resources, configuration changes, etc.)"

  footer:
    - "Breaking changes: 'BREAKING CHANGE: description'"
    - "Issue references: 'Refs #123' or 'Closes #123'"
    - "Include Claude Code attribution for AI-generated commits"

special_cases:
  multi_package:
    scope: "monorepo"

  breaking_change:
    footer_required: true
    footer_format: "BREAKING CHANGE: <description>"

  aws_resource_changes:
    body_should_include:
      - "Resource ARNs or names if relevant"
      - "Configuration changes (e.g., VPC CIDR, instance types)"
      - "Migration steps if required"

examples:
  slack_integration:
    type: "feat"
    scope: "backend"
    subject: "Add thread memory for conversation context"
    body: |
      Implement thread tracking to maintain conversation context across
      multiple Slack messages in the same thread.

      - Store thread_ts to parent_ts mapping in Redis
      - Include previous messages when building RAG context
      - Add 24-hour TTL to thread memory cache
    rationale: "Backend feature with implementation details in body"

  bedrock_integration:
    type: "feat"
    scope: "backend"
    subject: "Integrate Claude Sonnet 4.5 via Bedrock"
    body: |
      Add Amazon Bedrock client for AI-powered responses using Claude.

      - Configure Bedrock runtime client with APAC region
      - Implement streaming responses for real-time Slack messages
      - Add error handling for rate limits and model availability

      Model ID: anthropic.claude-sonnet-4-5-20250929-v1:0
    rationale: "Includes specific model details and configuration in body"

  infrastructure_deployment:
    type: "feat"
    scope: "infra"
    subject: "Deploy ECS Fargate with ECR for backend"
    body: |
      Set up ECS Fargate cluster with application load balancer,
      ECR repository for Docker images, and CloudWatch logging.

      Resources created:
      - ECS Cluster: chatbot-cluster
      - ECR Repository: chatbot-backend
      - Fargate Service: chatbot-service (1 task)
      - CloudWatch Log Group: /ecs/chatbot-backend
    rationale: "Lists AWS resources created for infrastructure changes"

  secrets_migration:
    type: "refactor"
    scope: "infra"
    subject: "Migrate Slack credentials to SSM Parameter Store"
    body: |
      Move Slack bot credentials from environment variables to
      AWS Systems Manager Parameter Store for better security.

      Parameters created:
      - /chatbot/slack/bot-token (SecureString)
      - /chatbot/slack/signing-secret (SecureString)
      - /chatbot/slack/app-token (SecureString)

      Updated ECS task definition to fetch parameters at runtime.
    rationale: "Security-related refactoring with specific parameter names"

  bug_fix:
    type: "fix"
    scope: "backend"
    subject: "Handle missing Bedrock response gracefully"
    body: |
      Add error handling when Bedrock API returns empty response
      or times out during RAG query.

      - Return fallback message to Slack user
      - Log error details to CloudWatch for debugging
      - Add retry logic with exponential backoff
    rationale: "Bug fix with detailed error handling approach"

  docker_update:
    type: "build"
    scope: "tools"
    subject: "Update Dockerfile to Node 25"
    body: |
      Upgrade base image from Node 23 to Node 25 for latest runtime.

      Using AWS Public ECR Gallery image for better compatibility with ECS.
    rationale: "Build change affecting Docker tooling"

  documentation:
    type: "docs"
    scope: "project"
    subject: "Add deployment guide for ECS Fargate"
    body: |
      Document the complete deployment process including:
      - Docker build and ECR push
      - CDK deployment steps
      - Environment variable configuration
      - Troubleshooting common issues
    rationale: "Documentation update for project-level guide"

  monorepo_dependency:
    type: "build"
    scope: "monorepo"
    subject: "Add Vitest for testing across workspaces"
    body: |
      Set up Vitest as the test runner for all packages.

      - Add vitest to root devDependencies
      - Configure workspace-level test scripts
      - Add coverage reporting
    rationale: "Dependency affecting multiple packages uses monorepo scope"

  breaking_change:
    type: "feat"
    scope: "backend"
    subject: "Change Bedrock model to Sonnet 4.5"
    body: |
      Switch from Claude 3.5 to Claude Sonnet 4.5 for improved reasoning
      and lower latency.

      BREAKING CHANGE: Requires updating BEDROCK_MODEL_ID environment variable.
      Set to: anthropic.claude-sonnet-4-5-20250929-v1:0

      Previous model ID will no longer be supported.
    rationale: "Breaking change requiring environment variable update"

workflow_integration:
  description: "How to use conventional commits skill during development"
  steps:
    - "After completing a feature/fix and tests pass"
    - "Stage changes: git add ."
    - "Invoke /commit command to use conventional-commits skill"
    - "Skill analyzes changed files and suggests appropriate type/scope"
    - "Review and approve generated commit message"
    - "Skill may split changes into multiple logical commits if needed"

  command_usage: |
    # In Claude Code, use the /commit slash command
    /commit

    # Or manually:
    git commit -m "type(scope): Subject line

    - Detailed explanation
    - Additional context

    ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

    Co-Authored-By: Claude <noreply@anthropic.com>"

project_specific_notes:
  - "This is a monorepo with backend (NestJS) + infra (CDK), no frontend"
  - "Backend handles Slack, Bedrock, knowledge management, and RAG"
  - "Infrastructure deploys to AWS (VPC, ECS, OpenSearch, Redis, RDS)"
  - "All commits should be attributed to Claude Code when AI-generated"
  - "Use descriptive subjects that explain the business value, not just technical changes"
  - "For AWS resources, include resource names/ARNs in commit body when relevant"
