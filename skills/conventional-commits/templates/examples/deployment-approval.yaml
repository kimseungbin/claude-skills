es# Example Commits: Deployment Approval
# Commits with Safe-To-Deploy footers for resource replacements

description: "Example commits with deployment safety footers"

# When LLM reads this file:
# - Pre-push hook blocked deployment
# - Needs examples of Safe-To-Deploy footer format
# - Wants to see real approval patterns

# Pattern: Infrastructure refactoring with manual deletion
refactoring_with_deletion:
  construct_extraction:
    message: "refactor(service): Extract ServiceInfraConstruct for two-phase deployment"
    body: |
      Separate build infrastructure from runtime service for independent deployment cycles.

      Changes Logical IDs but preserves resource names via overrideLogicalId().
      Manual deletion required for CodeBuild projects in each environment.

      Testing plan:
      1. Deploy auth service first
      2. Validate builds working for 24 hours
      3. Deploy yozm and support services
      4. Validate all services operational

      Safe-To-Deploy: manual-deletion-planned
      Analyzed-By: Kim Seungbin
      Services: auth,yozm,support
      Resources-Affected: CodeBuild=3
      Rationale: Two-phase deployment enables infrastructure updates without service downtime

      Skill: conventional-commits

    analysis_notes:
      - "Reviewed cdk diff output"
      - "Confirmed overrideLogicalId() preserves ECR, ECS, ALB names"
      - "Planned incremental rollout (auth first, then others)"
      - "Manual deletion script ready: aws cloudformation delete-stack"

    why_approved: |
      Resource replacement is intentional refactoring.
      Fixed names preserved via overrideLogicalId().
      Incremental rollout limits blast radius.

# Pattern: New environment with resource conflicts
new_environment:
  qa_environment:
    message: "feat(types): Add Environment.QA enum"
    body: |
      Add QA environment for pre-staging testing.

      Requires manual cleanup of existing QA stacks from previous attempt.
      Old stack name: "QADeployment" (incorrect)
      New stack name: "DeploymentStack" (corrected)

      Safe-To-Deploy: manual-deletion-planned
      Analyzed-By: Kim Seungbin
      Services: all
      Resources-Affected: DeploymentStack=1, GlobalStack=1
      Testing-Plan: Deploy to new AWS account, validate all services
      Rationale: Correct stack naming to match DEV pattern

      Skill: conventional-commits

    analysis_notes:
      - "Previous QA deployment used wrong stack naming"
      - "Must delete old stacks manually before redeployment"
      - "New account setup required"

    why_approved: |
      Name correction prevents future confusion.
      Old stacks will be manually deleted before deployment.

# Pattern: Configuration change causing replacements
config_optimization:
  fargate_sizing:
    message: "refactor(config): Optimize Fargate CPU allocation for low-traffic services"
    body: |
      Reduce CPU from 512 to 256 for partner and solution services.

      Triggers ECS service replacement due to task definition change.
      Services will experience brief downtime during replacement.

      Safe-To-Deploy: manual-deletion-planned
      Analyzed-By: Kim Seungbin
      Services: partner,solution
      Resources-Affected: ECS::Service=2, ECS::TaskDefinition=2
      Testing-Plan: Deploy partner first, monitor 4 hours, then solution
      Rationale: Cost optimization - services have low traffic (<10 req/min)

      Skill: conventional-commits

    analysis_notes:
      - "Monitored traffic for 7 days: peak 8 req/min"
      - "256 CPU sufficient for current load"
      - "Can roll back by reverting commit"

    why_approved: |
      Cost savings significant (~40%).
      Low-traffic services can handle smaller allocation.
      Easy rollback if issues detected.

# Pattern: Feature flag enabling new infrastructure
feature_flag_deployment:
  two_phase_deployment:
    message: "feat(feature-flags): Enable two-phase-deployment for QA environment"
    body: |
      Enable feature flag to test two-phase deployment in QA.

      Will create new ServiceInfraConstruct and ServiceAppConstruct.
      Requires manual deletion of old ServiceConstruct resources.

      Safe-To-Deploy: manual-deletion-planned
      Analyzed-By: Kim Seungbin
      Services: auth,yozm
      Resources-Affected: CodeBuild=2, Nested Stacks=2
      Testing-Plan: QA only, rollback if builds fail
      Rationale: Test new pattern in QA before PROD rollout

      Skill: conventional-commits

    analysis_notes:
      - "Feature flag limits blast radius to QA only"
      - "Can disable flag to roll back"
      - "Manual deletion script tested in DEV"

    why_approved: |
      QA environment is safe for testing.
      Feature flag provides quick rollback mechanism.

# Pattern: Emergency hotfix with replacements
emergency_fix:
  security_patch:
    message: "fix(lambda): Update Lambda runtime to patch security vulnerability"
    body: |
      Update Lambda runtime from nodejs18.x to nodejs20.x.

      CVE-2024-XXXXX requires immediate runtime update.
      Triggers Lambda function replacement (new ARN).

      Safe-To-Deploy: manual-deletion-planned
      Analyzed-By: Kim Seungbin
      Services: message-transformer,ecs-reboot
      Resources-Affected: Lambda::Function=2
      Testing-Plan: Deploy immediately, monitor invocations
      Rationale: Critical security patch, cannot wait

      Skill: conventional-commits

    analysis_notes:
      - "CVE confirmed in nodejs18.x"
      - "Lambda replacement is safe (no state)"
      - "All environments affected"

    why_approved: |
      Security vulnerability requires immediate fix.
      Lambda functions are stateless (safe to replace).

# Footer format reference
footer_format:
  required_fields:
    - "Safe-To-Deploy: manual-deletion-planned"
    - "Analyzed-By: <your-name>"
    - "Services: <service-list>"

  optional_fields:
    - "Resources-Affected: CodeBuild=1, ECS=2"
    - "Testing-Plan: Deploy X first, then Y"
    - "Rationale: Why this change is safe"

  example:
    message: "refactor(service): Extract ServiceInfraConstruct"
    footer: |
      Safe-To-Deploy: manual-deletion-planned
      Analyzed-By: Kim Seungbin
      Services: auth,yozm,support
      Resources-Affected: CodeBuild=3
      Testing-Plan: Deploy auth first, validate 24h, then others
      Rationale: Two-phase deployment pattern for independent infrastructure updates

      Skill: conventional-commits

# Analysis checklist (for humans)
approval_checklist:
  before_approval:
    - "[ ] Ran cdk diff and reviewed all changes"
    - "[ ] Identified resource replacements ([-/+] in diff)"
    - "[ ] Verified overrideLogicalId() for fixed-name resources"
    - "[ ] Checked for data loss risk (stateful resources)"
    - "[ ] Planned incremental rollout strategy"
    - "[ ] Prepared manual deletion commands"
    - "[ ] Tested in DEV environment (if applicable)"

  during_deployment:
    - "[ ] Manually delete old resources if needed"
    - "[ ] Monitor CloudWatch for errors"
    - "[ ] Validate service health checks passing"
    - "[ ] Check application logs for issues"

  rollback_plan:
    - "git revert <commit-hash>"
    - "git push origin master (triggers rollback deployment)"
    - "Manual cleanup of partial deployments if needed"

# Anti-patterns
antipatterns:
  vague_rationale:
    bad: |
      Safe-To-Deploy: manual-deletion-planned
      Analyzed-By: John Doe
      Services: all
      Rationale: Looks fine

    good: |
      Safe-To-Deploy: manual-deletion-planned
      Analyzed-By: John Doe
      Services: auth,yozm
      Resources-Affected: CodeBuild=2
      Testing-Plan: Deploy auth first, validate 24h
      Rationale: Two-phase deployment enables infrastructure updates without service downtime

  missing_analysis:
    bad: "Just added Safe-To-Deploy footer without analyzing cdk diff"
    good: "Ran cdk diff, reviewed all [-/+] changes, confirmed overrideLogicalId()"

  no_testing_plan:
    bad: "Approved without incremental rollout plan"
    good: "Planned incremental rollout: auth first (24h), then yozm and support"