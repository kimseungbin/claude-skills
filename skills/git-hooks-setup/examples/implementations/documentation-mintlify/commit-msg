#!/bin/bash

# commit-msg hook - Enforce commit-expert agent usage
#
# PURPOSE: Validate that commits are created via the commit-expert agent
# TRIGGER: After commit message is written, before commit is finalized
# USE CASE: Ensure all commits follow project's conventional commit standards
#
# CHECKS:
# 1. Commit message has required footer: "Agent: commit-expert"
# 2. Ensures consistent commit message format across the team
#
# BYPASS (Emergency only):
# git commit --no-verify -m "emergency: Critical fix"

# Git passes the commit message file as first argument
COMMIT_MSG_FILE="$1"

# Read the commit message
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Check if commit message has the agent marker
if ! echo "$COMMIT_MSG" | grep -q "Agent: commit-expert"; then
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "❌ COMMIT BLOCKED"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "This commit was not created using the commit-expert agent."
    echo ""
    echo "Required footer tag missing: 'Agent: commit-expert'"
    echo ""
    echo "┌─────────────────────────────────────────────────────┐"
    echo "│  HOW TO FIX:                                        │"
    echo "├─────────────────────────────────────────────────────┤"
    echo "│  ✅ Use: Task(subagent_type=\"commit-expert\")        │"
    echo "│  ❌ DO NOT use: git commit directly                 │"
    echo "└─────────────────────────────────────────────────────┘"
    echo ""
    echo "The agent ensures:"
    echo "  • Proper conventional commit format (type(scope): subject)"
    echo "  • Intelligent multi-commit splitting"
    echo "  • Follows project-specific commit rules"
    echo "  • Consistent capitalization and formatting"
    echo ""
    echo "Emergency bypass (use sparingly):"
    echo "  git commit --no-verify -m \"your message\""
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    exit 1
fi

# All checks passed
exit 0