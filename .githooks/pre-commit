#!/bin/bash

# Auto-bump plugin patch versions when plugin files change
# Updates both plugin.json and marketplace.json
# Skips if version was already manually bumped

set -e

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only)

# Track which plugins need version bump (using simple list for bash 3 compatibility)
PLUGINS_TO_BUMP=""

# Check each staged file to see if it's in a plugin directory
for file in $STAGED_FILES; do
    if [[ $file == plugins/*/* ]]; then
        # Extract plugin name
        plugin_name=$(echo "$file" | cut -d'/' -f2)
        # Add to list if not already present
        if ! echo "$PLUGINS_TO_BUMP" | grep -q "^${plugin_name}$"; then
            PLUGINS_TO_BUMP="$PLUGINS_TO_BUMP
$plugin_name"
        fi
    fi
done

# Bump version for each changed plugin
for plugin_name in $PLUGINS_TO_BUMP; do
    [[ -z "$plugin_name" ]] && continue
    plugin_json="plugins/$plugin_name/.claude-plugin/plugin.json"

    if [[ -f "$plugin_json" ]]; then
        # Get current version in working tree
        current_version=$(grep -o '"version": *"[^"]*"' "$plugin_json" | grep -o '[0-9]*\.[0-9]*\.[0-9]*')

        # Get version from last commit (HEAD)
        head_version=$(git show HEAD:"$plugin_json" 2>/dev/null | grep -o '"version": *"[^"]*"' | grep -o '[0-9]*\.[0-9]*\.[0-9]*' || echo "")

        # Skip if version was already manually bumped
        if [[ -n "$head_version" && "$current_version" != "$head_version" ]]; then
            echo "Skipping $plugin_name: version already bumped ($head_version → $current_version)"
            continue
        fi

        if [[ -n "$current_version" ]]; then
            # Parse version components
            IFS='.' read -r major minor patch <<< "$current_version"

            # Bump patch version
            new_patch=$((patch + 1))
            new_version="$major.$minor.$new_patch"

            # Update plugin.json
            sed -i '' "s/\"version\": *\"$current_version\"/\"version\": \"$new_version\"/" "$plugin_json"
            git add "$plugin_json"

            # Update marketplace.json if it exists
            marketplace_json=".claude-plugin/marketplace.json"
            if [[ -f "$marketplace_json" ]]; then
                # Update the version for this specific plugin in marketplace.json
                python3 -c "
import json
with open('$marketplace_json', 'r') as f:
    data = json.load(f)
for plugin in data.get('plugins', []):
    if plugin.get('name') == '$plugin_name':
        plugin['version'] = '$new_version'
with open('$marketplace_json', 'w') as f:
    json.dump(data, f, indent=2)
    f.write('\n')
"
                git add "$marketplace_json"
            fi

            echo "Auto-bumped $plugin_name: $current_version → $new_version"
        fi
    fi
done

exit 0